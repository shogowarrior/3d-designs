clear all
close all
clc

n=100;
theta=linspace(0,2*pi,n);
phi=linspace(-pi/2,pi/2,n);
[TH,PHI]=ndgrid(theta,phi);
for i=1:numel(TH)
    st=sin(TH(i));
    ct=cos(TH(i));
    sp=sin(PHI(i));
    cp=cos(PHI(i));
    a=cp^2*ct^2+9/4*cp^2*st^2+sp^2;
    b=sp^3*cp^2*ct^2+9/80*sp^3*cp^2*st^2;
    r=roots([a^3,-b,-3*a^2,0,3*a,0,-1]);
    for j=1:6
        if isreal(r(j))
            R1(i,j)=r(j);
        else
            R1(i,j)=nan;
        end
    end
end
R=max(R1,[],2);
R=reshape(R,n,[]);
[X,Y,Z]=sph2cart(TH,PHI,R);
xspan=max(max(X))-min(min(X));
scale=100/xspan;
X=X*scale;
Y=Y*scale;
Z=Z*scale;
surf(X,Y,Z)
daspect([1 1 1])
surf2stl('heart.stl',X,Y,Z);% download surf2stl from Matlab Central
% FVC=surf2patch(X,Y,Z);
% FV=reducepatch(FVC,.5);
% p=patch(FV);
% set(p, 'FaceColor', 'red', 'EdgeColor', 'none');
% daspect([1 1 1])
% view(3)
% camlight; lighting phong
% patch2stl('heart.stl',FV);% download patch2stl.m from Matlab Central
